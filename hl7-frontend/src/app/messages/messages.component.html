<h1>Données HL7</h1>

<!-- Boutons principaux -->
<div class="button-group" style="margin-bottom: 20px;">
  <button (click)="startParsing()">Lancer le parsing HL7</button>
  <button (click)="loadWishMessages()">Charger WISH</button>
  <button (click)="loadOrlineMessages()">Charger ORLINE</button>
  <button (click)="loadPatientsList()">Lister Patients</button>
  <button (click)="clearAllMessages()">Vider toutes les tables</button>
  <button (click)="goHome()">Retour au menu principal</button>
</div>

<!-- Recherche patient -->
<div class="patient-search">
  <label for="patientIdInput">Entrer un ID Patient :</label>
  <input id="patientIdInput" [(ngModel)]="patientId" placeholder="ID Patient" />
  <button (click)="rechercherMessages()">Rechercher</button>
</div>

<!-- Recherche séjour -->
<div class="sejour-select">
  <label for="sejourInput">Voir les séjours pour un patient :</label>
  <input id="sejourInput" [(ngModel)]="selectedPatientId" placeholder="ID Patient à explorer" />
  <button (click)="rechercherSejours()">Charger Séjours</button>

  <div *ngIf="sejoursPatient.length > 0">
    <label for="sejourSelect">Sélectionner un séjour :</label>
    <select [(ngModel)]="selectedSejour" id="sejourSelect">
      <option *ngFor="let sejour of sejoursPatient" [value]="sejour">{{ sejour }}</option>
    </select>
    <button (click)="loadMessagesBySejour()">Afficher les messages du séjour</button>
  </div>
</div>

<!-- Section liste patients -->
<div class="patients-list" *ngIf="patientsList.length > 0">
  <label>Filtrer par source :</label>
  <select [(ngModel)]="selectedSourceFilter" (change)="loadPatientsWithFilter()">
    <option value="both">Tous</option>
    <option value="wish">WISH</option>
    <option value="orline">ORLINE</option>
    <option value="intersection">Intersection</option>
  </select>

  <div class="total">Nombre total de patients : {{ totalPatients }}</div>

  <ul>
    <li *ngFor="let pat of patientsList" (click)="loadPatientMessages(pat)">
      {{ pat }}
    </li>
  </ul>
</div>


<!-- Affichage messages -->
<div class="hl7-messages-section" *ngIf="messages.length > 0">
  <h2>Messages HL7</h2>
  <table class="hl7-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Source</th>
        <th>Date de création</th>
        <th>Contenu brut</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let msg of messages">
        <td>{{ msg.id }}</td>
        <td>{{ msg.source }}</td>
        <td>{{ msg.created_at }}</td>
        <td><pre>{{ msg.raw_preview }}</pre></td>
      </tr>
    </tbody>
  </table>
</div>


<div *ngIf="messages.length === 0 && !isLoading" class="alert">
  Aucun message à afficher.
</div>

<div *ngIf="isLoading">
  <p>Chargement en cours...</p>
</div>
